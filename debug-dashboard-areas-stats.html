<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Dashboard Areas Stats - FANTEA</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f8f9fa;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .warning { background-color: #fff3cd; color: #856404; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 3px;
            font-size: 12px;
        }
        button:hover { background: #0056b3; }
        .log {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.4;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 10px 0;
        }
        .data-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }
        .stat-row {
            display: grid;
            grid-template-columns: 1fr 2fr 2fr;
            gap: 10px;
            padding: 8px;
            border-bottom: 1px solid #eee;
            align-items: center;
        }
        .stat-row:last-child { border-bottom: none; }
        .stat-number { font-weight: bold; color: #007bff; }
        .mismatch { background-color: #ffebee; color: #c62828; }
        .match { background-color: #e8f5e8; color: #2e7d32; }
        h1, h2, h3 { color: #2c3e50; }
    </style>
    <script src="js/config.js"></script>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Dashboard Areas Stats</h1>
        <p>Herramienta para debuggear el problema de sincronizaci√≥n de estad√≠sticas en el dashboard.</p>

        <div class="debug-section">
            <h2>Estado del Sistema</h2>
            <div id="system-status"></div>
            <button onclick="checkSystemStatus()">Verificar Estado</button>
        </div>

        <div class="debug-section">
            <h2>Datos del Servidor vs Dashboard</h2>
            <div class="comparison">
                <div>
                    <h3>üì° Datos del Servidor</h3>
                    <div id="server-data" class="data-display">Cargando...</div>
                </div>
                <div>
                    <h3>üñ•Ô∏è Datos del Dashboard (Simulaci√≥n)</h3>
                    <div id="dashboard-data" class="data-display">
                        <div class="stat-row">
                            <div><strong>Stat 1:</strong></div>
                            <div>N√∫mero: <input type="text" id="sim-number1" value="55" style="width:60px;"></div>
                            <div>Desc: <input type="text" id="sim-desc1" value="√Åreas de Intervenci√≥n" style="width:150px;"></div>
                        </div>
                        <div class="stat-row">
                            <div><strong>Stat 2:</strong></div>
                            <div>N√∫mero: <input type="text" id="sim-number2" value="15+" style="width:60px;"></div>
                            <div>Desc: <input type="text" id="sim-desc2" value="A√±os de Experiencia" style="width:150px;"></div>
                        </div>
                        <div class="stat-row">
                            <div><strong>Stat 3:</strong></div>
                            <div>N√∫mero: <input type="text" id="sim-number3" value="1000+" style="width:60px;"></div>
                            <div>Desc: <input type="text" id="sim-desc3" value="Familias Atendidas" style="width:150px;"></div>
                        </div>
                        <div class="stat-row">
                            <div><strong>Stat 4:</strong></div>
                            <div>N√∫mero: <input type="text" id="sim-number4" value="50+" style="width:60px;"></div>
                            <div>Desc: <input type="text" id="sim-desc4" value="Profesionales Formados" style="width:150px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <button onclick="loadServerData()">Cargar Datos del Servidor</button>
            <button onclick="compareData()">Comparar Datos</button>
            <button onclick="simulateLoadSectionData()">Simular loadSectionData</button>
        </div>

        <div class="debug-section">
            <h2>Pruebas de Sincronizaci√≥n</h2>
            <button onclick="testDashboardFunction()">Probar checkAreasStats()</button>
            <button onclick="updateTestValue()">Actualizar Valor de Prueba</button>
            <button onclick="forceDashboardSync()">Forzar Sync Dashboard</button>
            <button onclick="testLocalStorage()">Verificar localStorage</button>
        </div>

        <div class="debug-section">
            <h2>Comparaci√≥n de Valores</h2>
            <div id="comparison-result"></div>
        </div>

        <div class="debug-section">
            <h2>Log de Debug</h2>
            <button onclick="clearLogs()">Limpiar Logs</button>
            <div class="log" id="debug-log"></div>
        </div>
    </div>

    <script>
        let logContainer;
        let serverAreasStats = null;

        document.addEventListener('DOMContentLoaded', () => {
            logContainer = document.getElementById('debug-log');
            log('üöÄ Debug Dashboard Areas Stats iniciado');
            
            // Auto-verificar estado al cargar
            setTimeout(() => {
                checkSystemStatus();
                loadServerData();
            }, 1000);
        });

        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            
            if (logContainer) {
                const logEntry = document.createElement('div');
                logEntry.innerHTML = logMessage;
                if (data) {
                    logEntry.innerHTML += '<br>' + JSON.stringify(data, null, 2);
                }
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            console.log(logMessage, data);
        }

        function checkSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            let html = '';

            // Verificar CMS_CONFIG
            if (window.CMS_CONFIG) {
                html += '<div class="status success">‚úÖ CMS_CONFIG disponible</div>';
                log('‚úÖ CMS_CONFIG disponible');
            } else {
                html += '<div class="status error">‚ùå CMS_CONFIG no disponible</div>';
                log('‚ùå CMS_CONFIG no disponible');
            }

            // Verificar localStorage
            try {
                const cmsData = localStorage.getItem('fantea_cms_data');
                if (cmsData) {
                    const parsedData = JSON.parse(cmsData);
                    if (parsedData['areas-stats']) {
                        html += '<div class="status success">‚úÖ areas-stats en localStorage</div>';
                        log('‚úÖ areas-stats en localStorage', parsedData['areas-stats']);
                    } else {
                        html += '<div class="status warning">‚ö†Ô∏è No hay areas-stats en localStorage</div>';
                        log('‚ö†Ô∏è No hay areas-stats en localStorage');
                    }
                } else {
                    html += '<div class="status warning">‚ö†Ô∏è No hay datos en localStorage</div>';
                    log('‚ö†Ô∏è No hay datos en localStorage');
                }
            } catch (error) {
                html += '<div class="status error">‚ùå Error leyendo localStorage</div>';
                log('‚ùå Error leyendo localStorage', error);
            }

            statusDiv.innerHTML = html;
        }

        async function loadServerData() {
            try {
                log('üîç Cargando datos del servidor...');
                
                const response = await fetch(CMS_CONFIG.apiUrls.load, {
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data && result.data['areas-stats']) {
                        serverAreasStats = result.data['areas-stats'];
                        displayServerData(serverAreasStats);
                        log('‚úÖ Datos del servidor cargados', serverAreasStats);
                    } else {
                        log('‚ö†Ô∏è No hay datos de areas-stats en la respuesta del servidor');
                        displayNoServerData();
                    }
                } else {
                    log('‚ùå Error en respuesta del servidor:', response.status);
                    displayNoServerData();
                }
            } catch (error) {
                log('‚ùå Error cargando datos del servidor:', error);
                displayNoServerData();
            }
        }

        function displayServerData(statsData) {
            const display = document.getElementById('server-data');
            if (!statsData || !statsData.items) {
                displayNoServerData();
                return;
            }

            let html = '';
            statsData.items.forEach((stat, index) => {
                html += `
                    <div class="stat-row">
                        <div><strong>Stat ${index + 1}:</strong></div>
                        <div class="stat-number">N√∫mero: "${stat.number}"</div>
                        <div>Desc: "${stat.description}"</div>
                    </div>
                `;
            });

            display.innerHTML = html;
        }

        function displayNoServerData() {
            const display = document.getElementById('server-data');
            display.innerHTML = '<div class="status warning">‚ö†Ô∏è No hay datos del servidor</div>';
        }

        function compareData() {
            if (!serverAreasStats) {
                log('‚ö†Ô∏è No hay datos del servidor para comparar');
                return;
            }

            log('üîç Comparando datos...');
            const comparisonDiv = document.getElementById('comparison-result');
            let html = '<h3>Resultado de Comparaci√≥n:</h3>';

            serverAreasStats.items.forEach((serverStat, index) => {
                const simNumber = document.getElementById(`sim-number${index + 1}`).value;
                const simDesc = document.getElementById(`sim-desc${index + 1}`).value;
                
                const numberMatch = serverStat.number === simNumber;
                const descMatch = serverStat.description === simDesc;
                
                const rowClass = (numberMatch && descMatch) ? 'match' : 'mismatch';
                
                html += `
                    <div class="stat-row ${rowClass}">
                        <div><strong>Stat ${index + 1}:</strong></div>
                        <div>
                            N√∫mero: Server="${serverStat.number}" vs Dashboard="${simNumber}" 
                            ${numberMatch ? '‚úÖ' : '‚ùå'}
                        </div>
                        <div>
                            Desc: Server="${serverStat.description}" vs Dashboard="${simDesc}" 
                            ${descMatch ? '‚úÖ' : '‚ùå'}
                        </div>
                    </div>
                `;
                
                log(`üìä Stat ${index + 1}: N√∫mero ${numberMatch ? 'MATCH' : 'MISMATCH'} (${serverStat.number} vs ${simNumber})`);
                log(`üìä Stat ${index + 1}: Desc ${descMatch ? 'MATCH' : 'MISMATCH'} (${serverStat.description} vs ${simDesc})`);
            });

            comparisonDiv.innerHTML = html;
        }

        function simulateLoadSectionData() {
            if (!serverAreasStats) {
                log('‚ö†Ô∏è No hay datos del servidor para simular');
                return;
            }

            log('üîÑ Simulando loadSectionData para areas-stats...');
            
            // Simular la funci√≥n loadSectionData
            serverAreasStats.items.forEach((stat, index) => {
                const numberField = document.getElementById(`sim-number${index + 1}`);
                const descField = document.getElementById(`sim-desc${index + 1}`);
                
                if (numberField && stat.number) {
                    log(`üìä Actualizando stat ${index + 1} n√∫mero: "${numberField.value}" -> "${stat.number}"`);
                    numberField.value = stat.number;
                }
                if (descField && stat.description) {
                    log(`üìä Actualizando stat ${index + 1} descripci√≥n: "${descField.value}" -> "${stat.description}"`);
                    descField.value = stat.description;
                }
            });
            
            log('‚úÖ Simulaci√≥n de loadSectionData completada');
        }

        function testDashboardFunction() {
            log('üß™ Probando funci√≥n checkAreasStats() del dashboard...');
            
            if (window.checkAreasStats) {
                window.checkAreasStats();
                log('‚úÖ checkAreasStats() ejecutada');
            } else {
                log('‚ùå checkAreasStats() no est√° disponible - necesitas estar en el dashboard');
            }
        }

        async function updateTestValue() {
            try {
                log('üß™ Actualizando valor de prueba...');
                
                const testData = {
                    items: [
                        { number: Math.floor(Math.random() * 100) + '++', description: '√Åreas de Intervenci√≥n' },
                        { number: '15+', description: 'A√±os de Experiencia' },
                        { number: '1000+', description: 'Familias Atendidas' },
                        { number: '50+', description: 'Profesionales Formados' }
                    ]
                };

                const response = await fetch(CMS_CONFIG.apiUrls.save, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        section: 'areas-stats',
                        data: testData,
                        user: 'debug-user'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        log('‚úÖ Valor de prueba guardado', testData);
                        setTimeout(() => {
                            loadServerData();
                        }, 1000);
                    } else {
                        log('‚ùå Error guardando valor de prueba:', result.error);
                    }
                } else {
                    log('‚ùå Error en respuesta del servidor:', response.status);
                }
            } catch (error) {
                log('‚ùå Error actualizando valor de prueba:', error);
            }
        }

        function forceDashboardSync() {
            log('üöÄ Forzando sincronizaci√≥n del dashboard...');
            
            if (window.forceDashboardSync) {
                window.forceDashboardSync();
                log('‚úÖ forceDashboardSync() ejecutada');
            } else {
                log('‚ùå forceDashboardSync() no est√° disponible - necesitas estar en el dashboard');
            }
        }

        function testLocalStorage() {
            log('üì¶ Verificando localStorage...');
            
            try {
                const cmsData = localStorage.getItem('fantea_cms_data');
                if (cmsData) {
                    const parsedData = JSON.parse(cmsData);
                    if (parsedData['areas-stats']) {
                        log('‚úÖ areas-stats en localStorage:', parsedData['areas-stats']);
                        
                        // Comparar con datos del servidor
                        if (serverAreasStats) {
                            const localString = JSON.stringify(parsedData['areas-stats']);
                            const serverString = JSON.stringify(serverAreasStats);
                            
                            if (localString === serverString) {
                                log('‚úÖ localStorage y servidor est√°n sincronizados');
                            } else {
                                log('‚ùå localStorage y servidor NO est√°n sincronizados');
                                log('üì¶ localStorage:', parsedData['areas-stats']);
                                log('üì° Servidor:', serverAreasStats);
                            }
                        }
                    } else {
                        log('‚ö†Ô∏è No hay areas-stats en localStorage');
                    }
                } else {
                    log('‚ö†Ô∏è No hay datos CMS en localStorage');
                }
            } catch (error) {
                log('‚ùå Error verificando localStorage:', error);
            }
        }

        function clearLogs() {
            if (logContainer) {
                logContainer.innerHTML = '';
            }
        }

        // Auto-refresh cada 10 segundos
        setInterval(() => {
            if (document.visibilityState === 'visible') {
                loadServerData();
            }
        }, 10000);
    </script>
</body>
</html>
